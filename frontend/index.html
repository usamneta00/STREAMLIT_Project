<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Assistant | Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="static/js/main.js" defer></script>

    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
    <script src="static/js/jquery-3.7.1.min.js"></script>
    <script src="static/js/marked.min.js"></script>
    <script src="static/js/highlight.js"></script>

    <link rel="stylesheet" href="static/css/highlight/github.css" id="light-theme-highlight">
    <link rel="stylesheet" href="static/css/highlight/github-dark.css" id="dark-theme-highlight">
    <link rel="stylesheet" href="static/css/style.css">

    <link rel="icon" type="image/png" href="static/images/website_top_logo_icon-150x150.png" alt="Logo">

    <style>
        .hidden { display: none !important; }

        /* Custom subtle scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(227, 224, 224, 0.5) transparent;
        }
        *::-webkit-scrollbar { width: 4px; height: 4px; }
        *::-webkit-scrollbar-thumb { background-color: rgba(227, 224, 224, 0.5); border-radius: 3px; }
        *::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
        <aside class="sidebar" style="transform: translateX(0px); opacity: 1;">
            <div class="collapse-btn-group" style="position: absolute; left: 20px; display: flex;">
                <div style="display: flex; align-items: center;">
                    <div class="vertical-divider"></div>
                    <button class="collapse-btn button-arrow">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <line x1="4" y1="12" x2="20" y2="12"></line>
                            <polyline points="14 6 20 12 14 18"></polyline>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="brand">
                <span class="logo-icon" style="font-size: 2rem;">ğŸ—ºï¸</span>
                <h2 style="font-size: 1.2rem; margin: 0; color: #4B49AC;">AI Travel <span style="color: #af2929;">Assistant</span></h2>
                <div class="separator"></div>
            </div>

            <nav class="nav-links">
                <ul class="menu-list">
                    <li class="menu-item active">
                        <a href="#" class="menu-link">
                            <i class="fas fa-comment"></i>
                            <span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø°ÙƒÙŠØ©</span>
                        </a>
                    </li>
                    <li class="menu-item disabled">
                        <a href="#" class="menu-link">
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <i class="fas fa-comments icon" style="font-size: 80px; margin-bottom: 15px;"></i>
                                <span class="text" style="text-align: center;">Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ AI Travel Assistant.
                                    Ø§Ø¨Ø¯Ø£ ÙˆØ§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ù…Ø³ØªØ¹Ø¯Ø§Ù‹.
                                </span>
                            </div>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
            <div class="user-panel">
                <div class="user-info">
                    <img src="static/images/avatar.png" alt="User Avatar" class="avatar">
                    <span class="username"></span>
                </div>
                <div class="user-actions">
                    <button class="settings-btn">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <main class="main-content" style="margin-right: 285px; width: calc(100% - 250px);">
            <!-- Ø²Ø± Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ -->
            <button class="restore-sidebar" style="display: none;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
            </button>

            <header class="navbar">
                <div class="breadcrumb" style="display:flex;align-items:center;gap:10px;">
                    <i class="fas fa-brain" style="font-size:1.3em;color:#af2929;"></i>

                    <span style="font-weight:600;font-size:1.1em;">AI Travel Assistant</span>
                </div>
                <div class="navbar-actions">
                    <button class="api-key-btn" title="Ù…ÙØªØ§Ø­ API">
                        <i class="fas fa-key"></i>
                    </button>
                    <button class="info-btn" title="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="theme-toggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="user-menu">
                        <div class="user-avatar">YS</div>
                    </div>
                </div>
            </header>

            <div class="content">
                <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
                <div class="chat-area" id="chatArea">
                    <div class="message-list">
                        <div class="image-grid messages-grid" id="messagesGrid">
                        </div>
                    </div>

                    <div class="message-input">
                        <textarea placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
                        <button class="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="send-btn voice-button" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
    <div class="progress-bar-container" id="progressBar" style="display: none;">
        <div class="progress-bar" style="width: 0%;"></div>
    </div>

    <script>
        // Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø«ÙŠÙ…
        let isDarkMode = localStorage.getItem('darkMode') === 'true';

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const themeToggle = document.querySelector('.theme-toggle');
        const messageInput = document.querySelector('.message-input textarea');
        const sendBtn = document.querySelector('.send-btn');
        const messageList = document.querySelector('.message-list');
        const messagesGrid = document.getElementById('messagesGrid');

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ÙŠØ§Ø±Ø§Øª marked
        marked.setOptions({
            gfm: true,
            breaks: true,
            tables: true,
            langPrefix: 'language-',
        });

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            themeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun');
            document.getElementById('light-theme-highlight').disabled = true;
            document.getElementById('dark-theme-highlight').disabled = false;
        } else {
            document.getElementById('light-theme-highlight').disabled = false;
            document.getElementById('dark-theme-highlight').disabled = true;
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø«ÙŠÙ…
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');

            const icon = themeToggle.querySelector('i');
            if (isDarkMode) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                document.getElementById('light-theme-highlight').disabled = true;
                document.getElementById('dark-theme-highlight').disabled = false;
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                document.getElementById('light-theme-highlight').disabled = false;
                document.getElementById('dark-theme-highlight').disabled = true;
            }

            localStorage.setItem('darkMode', isDarkMode);
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        themeToggle.addEventListener('click', toggleTheme);

        sendBtn.addEventListener('click', async function (e) {
            if (messageInput.value.trim() !== '') {
                const inputText = messageInput.value.trim();
                messageInput.value = '';
                messageInput.disabled = true;
                try {
                    await addMessage(inputText);
                } finally {
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            }
        });

        messageInput.addEventListener('keypress', async function (e) {
            if (e.key === 'Enter' && !e.shiftKey && this.value.trim() !== '') {
                e.preventDefault();
                const inputText = this.value.trim();
                this.value = '';
                this.disabled = true;
                try {
                    await addMessage(inputText);
                } finally {
                    this.disabled = false;
                    this.focus();
                }
            }
        });

        // Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        let chatHistory = [];

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
        async function sendQuery(query) {
            const progressBar = document.getElementById('progressBar');
            const progressBarFill = progressBar.querySelector('.progress-bar');

            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';

            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 1;
                    progressBarFill.style.width = `${progress}%`;
                }
            }, 50);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, history: chatHistory })
                });

                if (!response.ok) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
                }

                const data = await response.json();
                clearInterval(progressInterval);
                progressBarFill.style.width = '100%';

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ù†Ø³Ù‚
                processMarkdownResponse(data.answer);

                // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                chatHistory.push({ role: 'user', content: query });
                chatHistory.push({ role: 'assistant', content: data.answer });

            } catch (error) {
                clearInterval(progressInterval);
                console.error('Ø®Ø·Ø£:', error);
                processMarkdownResponse(`### Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©\n\`\`\`\n${error.message}\n\`\`\``);
            } finally {
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressBarFill.style.width = '0%';
                }, 1000);
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function createMessageElement(text, type = 'user-message', label = 'Ø§Ù„Ø³Ø¤Ø§Ù„') {
            const emptyState = messagesGrid.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${type}`;

            messageDiv.innerHTML = `
                <div class="message-label">${label}</div>
                <div class="message-container" style="display: flex; align-items: flex-start; gap: 12px;">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div style="flex: 1;">
                        <div class="starfox-cards" style="background: transparent; border-radius: 15px 15px 15px 0; max-width: 80%;">
                            <div class="starfox-card" style="border-radius: inherit;">
                                <div class="starfox-card__content" style="padding: 12px 15px;">
                                    <p class="starfox-paragraph starfox-paragraph--md" style="margin: 0;">
                                        ${text}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="message-time" style="font-size: 12px; color: #646974; margin-top: 4px;">
                            ${new Date().toLocaleTimeString()}
                        </div>
                    </div>
                </div>
            `;

            messagesGrid.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø±Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ØªÙ†Ø³ÙŠÙ‚ Markdown
        function processMarkdownResponse(response) {
            const emptyState = messagesGrid.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble system-message markdown-content';

            let markdownText = response;
            if (typeof response === 'string') {
                const htmlContent = marked.parse(markdownText, {
                    gfm: true,
                    breaks: true,
                    tables: true,
                    pedantic: false,
                    sanitize: false,
                    smartLists: true,
                    smartypants: true
                });

                messageDiv.innerHTML = `
                    <div class="message-label">Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                    <div class="message-container" style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="flex: 1;">
                            <div class="starfox-cards" style="border-radius: 15px 15px 15px 0; max-width: 80%;">
                                <div class="starfox-card" style="border-radius: inherit;">
                                    <div class="starfox-card__content" style="padding: 12px 15px;">
                                        <p class="starfox-paragraph starfox-paragraph--md" style="margin: 0;">
                                            ${htmlContent}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="message-time"></div>
                `;
            }

            messagesGrid.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth' });

            // ØªØ·Ø¨ÙŠÙ‚ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
            const codeBlocks = messageDiv.querySelectorAll('pre code');
            codeBlocks.forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        async function addMessage(text) {
            try {
                createMessageElement(text, 'user-message', 'Ø§Ù„Ø³Ø¤Ø§Ù„');
                await sendQuery(text);
            } catch (error) {
                console.error('Error in addMessage:', error);
                processMarkdownResponse('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ');
            }
        }
    </script>
</body>

</html>
